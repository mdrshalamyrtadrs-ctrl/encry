<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.plyr.io https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.plyr.io https://fonts.googleapis.com; font-src https://fonts.gstatic.com; media-src 'self' blob: https:; connect-src 'self' /api/ https:;">
  <title>ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ - Ù…Ù†ØµØ© THE BEST</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="secure-auth.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      background: radial-gradient(circle at top, #0a0a0a, #000);
      color: #fff;
      margin: 0;
      text-align: center;
      overflow-x: hidden;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #111;
      padding: 14px 18px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
    }

    .title {
      color: #ffd700;
      font-weight: 700;
      font-size: 18px;
      text-shadow: 0 0 8px #ffd700;
    }

    .back {
      font-size: 22px;
      cursor: pointer;
      color: #ffd700;
      transition: transform 0.3s;
      user-select: none;
    }

    .back:hover {
      transform: translateX(-5px);
    }

    #player {
      max-width: 950px;
      width: 100%;
      height: 60vh;
      border-radius: 18px;
      margin: 25px auto;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
      background: #000;
    }

    #hint {
      margin-top: 12px;
      color: #ffd700;
      font-size: 14px;
      text-shadow: 0 0 4px #ffd700;
    }

    .error-msg {
      margin: 40px auto;
      color: #ff4d4d;
      font-size: 20px;
      font-weight: 700;
      text-shadow: 0 0 8px #ff0000;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="back" onclick="history.back()">â¬…</div>
    <div class="title">ğ‘·ğ’ğ’‚ğ’š ğ‘½ğ’Šğ’…ğ’†ğ’ ğŸ¬</div>
    <div style="width:25px;"></div>
  </div>

  <video id="player" playsinline controls poster="poster.jpg"></video>
  <div id="hint">ğŸ’¡ Ø§Ø³Ø­Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ØªÙ‚Ø¯ÙŠÙ…Ù‡ Ø£Ùˆ ØªØ£Ø®ÙŠØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ</div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    // Verify authentication before playing video
    (async function () {
      const isAuth = await SecureAuth.protectPage("index.html");
      if (!isAuth) return;
      SecureAuth.startSessionMonitor(60000);
    })();

    let qualitySources = [];
    let videoTitle = sessionStorage.getItem("video_title") || "Lecture Video";
    const savedSources = sessionStorage.getItem("video_sources");

    if (savedSources) {
      try {
        const videoData = JSON.parse(savedSources);

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø®Ø²Ù† ÙƒÙ…ØµÙÙˆÙØ© (Ù…Ø¹Ø¸Ù… Ø§Ù„Ø£Ø­ÙŠØ§Ù† Ù‡ØªÙƒÙˆÙ† Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯)
        if (Array.isArray(videoData)) {
          qualitySources = videoData.map(v => ({
            src: v.stream_url || v.src || v,  // Ø§Ø³ØªØ®Ø¯Ø§Ù… stream_url Ø£ÙˆÙ„Ù‹Ø§
            type: "application/x-mpegURL",
            size: parseInt(v.label) || 720
          }));
        } else {
          qualitySources = [{
            src: videoData.stream_url || videoData.src || videoData,
            type: "application/x-mpegURL",
            size: parseInt(videoData.label) || 720
          }];
        }

      } catch (err) {
        console.error("âŒ Error parsing savedSources:", err);
      }
    } else {
      document.body.innerHTML = "<div class='error-msg'>Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ğŸ˜¢</div>";
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø¯Ù…Ø¬Ø©
    const player = new Plyr('#player', {
      controls: [
        'play-large', 'play', 'rewind', 'fast-forward', 'progress', 'current-time', 'duration',
        'mute', 'volume', 'settings', 'fullscreen'
      ],
      settings: ['quality', 'speed', 'loop'],
      rewindTime: 10,
      forwardTime: 10
    });

    // ØªØ´ØºÙŠÙ„ HLS Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ØµÙŠØºØ© m3u8
    if (qualitySources.length > 0) {
      const firstSrc = qualitySources[0].src;
      if (typeof firstSrc === "string" && firstSrc.endsWith(".m3u8") && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(firstSrc);
        hls.attachMedia(document.getElementById('player'));
      } else {
        player.source = {
          type: 'video',
          title: videoTitle,
          sources: qualitySources
        };
      }
    }

    // ğŸ”„ Fullscreen ÙˆØªØ¯ÙˆÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    player.on('play', async () => {
      try {
        if (!player.fullscreen.active) player.fullscreen.enter();
        if (screen.orientation && screen.orientation.lock) {
          await screen.orientation.lock('landscape');
          console.log("ğŸ“± ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
        }
      } catch (err) {
        console.warn("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", err);
      }
    });

    // â° Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    player.on('ended', () => {
      alert("ğŸ¬ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
    });

    // Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù…ÙŠØ­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø®ÙÙŠØ© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ)
    setTimeout(() => document.getElementById('hint').style.display = 'none', 5000);
  </script>


</body>

</html>